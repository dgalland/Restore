<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ru">
<head>
  <meta content="text/html;charset=Windows-1251" http-equiv="Content-Type">
  <title>DeSpot Plugin for Avisynth</title>
  <link rel="stylesheet" type="text/css" href="../avisynth.css">
</head>
<body>
<h1>DeSpot</h1>
<h4>DeSpot - Условный временной удаляющий пятна фильтр</h4>
<p>Плагин для <a href="http://www.avisynth.org">AviSynth 2.5</a><br>
Версия 3.6.1<br>
Copyright (c)2003-2009 Александр Г. Балахнин aka Fizick<br>
<a href="http://avisynth.org.ru">http://avisynth.org.ru</a></p>

<p>Данный фильтр разработан для удаления временного шума в форме точек (пятен) и полосок, имеющихся в некоторых видео.<br>
Фильтр полезен для реставрации кинофильмов путем удаления случайных
помех в виде темных пятен от пыли и некоторых полос от
царапин на оцифрованных кинопленках.</p>

<p>Плагин основан на условном временном медианном
фильтре Conditional Temporal Median Filter v.0.93 (C-plugin for Avisynth 2.5)<br>
by Kevin Atkinson <a href="http://kevin.atkinson.dhs.org/temporal_median/"> http://kevin.atkinson.dhs.org/temporal_median/</a><br>
(эта документация также основана на нем.)</p>
<h3>Примеры работы фильтра</h3>
<p>Пример полукадра старой 8мм кинопленки (вверху - до фильтра, внизу - после действия фильтра):</p>
<p><img src="conditional.jpg" border="0" width="720" height="576"></p>
<p>&nbsp;Avisynth скрипт-файл для примера, показывающий возможности старой базовой версии 0.93, но адаптированный для версии 3.2:</p>
<pre>AviSource("film8mm.avi")
LoadPlugin("despot.dll")
ConvertToYV12()
Crop(0,0,720,288) # чтобы показать тест
i = last
# Сравним полу-кадры с и без подавлением шума
DeSpot(p1=35, p2=14, pwidth=70, pheight=70, mthres=25, mwidth=20, mheight=15, interlaced=false,
  \  merode=33, ranked=false, p1percent=0, dilate=0, fitluma=false, blur=0, motpn=false, seg=0)
StackVertical(i, last)</pre>
<p>Тот же пример с использованием параметров более новой версии 1.0
фильтра (вверху - с размазыванием границ пятен, внизу - с
дополнительной временной фильтрацией)</p>
<p><img src="despot.jpg" border="0" width="720" height="576"></p>
<p>Использованные для примера команды скрипта :</p>
<pre>AviSource("film8mm.avi")
LoadPlugin("despot.dll")
ConvertToYV12()
Crop(0,0,720,288)
# Сравним кадры с блюром, с и без временным сглаживанием
i = last
b = DeSpot(i, p1=35, p2=14, pwidth=70, pheight=70, mthres=25, mwidth=20, mheight=15, interlaced=false,
  \  merode=33, ranked=false, p1percent=0, dilate=0, fitluma=false, blur=4, motpn=false, seg=0)
t = DeSpot(i, p1=35, p2=14, pwidth=70, pheight=70, mthres=25, mwidth=20, mheight=15, interlaced=false,
  \  merode=33, ranked=false, p1percent=0, dilate=0, fitluma=false, blur=4, motpn=false, seg=0, tsmooth=3)
StackVertical(b, t)</pre>
<p>В новых версиях фильтра введены дополнительные параметры для большей
надежности детектирования пятен и их удаления без внесения артефактов.</p>
<h3>Необходимые программы</h3>
<ol>
  <li>Данная программа является плагином (фильтром)
для Avisynth 2.5 (http://www.avisynth.org). Тестировался с
версиями 2.5.3 - 2.5.8.</li>
  <li>Старые
версии фильтра (перед 2.0 вплоть до 1.3) нуждались в Avisynth C
интерфейсе (avithynth_c.dll) от Kevin Atkinson. Отмечались некоторые
проблемы.</li>
  <li>Новый фильтр c версии 2.0 является родным плагином Avisynth и более НЕ нуждается в C-интерфейсе.</li>
</ol>
<h3>ИСПОЛЬЗОВАНИЕ</h3>
<p>DeSpot может быть загружен как любой AviSynth плагин, помещением в
каталог плагинов или используя LoadPlugin. 
Клип должен иметь YV12 или специальный планарный YUY2 формат. 
Базовое использование:</p>
<pre>AviSource("d:\video.avi") 
LoadPlugin("despot.dll")
ConvertToYV12()
DeSpot(p1=35, p2=14, mthres=25)</pre>
<p>Фильтр может работать в двух режимах переключаемых новым параметром <var>median</var> (с версии 2.0):<br>
<var>median</var> (true or false, default = false),<br>
false - режим удаления пятен - фильтр пытается идентифицировать шум и исключить его.<br>
true - медианный режим - будет просто прилагать простой временной медианный
(усредняющий) фильтр к не-движущимся областям образа.<br>
</p>
<p>Вызов функции:</p>
<p><code>DeSpot</code>(<var>clip, int "mthres", int "mwidth", int "mheight",
int "merode", bool "interlaced", bool "median", int "p1", int "p2", int "pwidth",
int "pheight", bool "ranked", int "sign", int "maxpts", int "p1percent",
int "dilate", bool "fitluma", int "blur", int "tsmooth", int "show", int "mark_v", 
bool "show_chroma", bool "motpn", int "seg", bool "color", int "mscene", int "minpts",
clip "extmask", bool "planar"</var>)
<h4>Параметры для DeSpot в режиме удаления пятен:</h4>
<p><var>p1</var> (default 24)<br>
<var>p2</var> (default 12)<br>
Пиксел (точка) должен отличаться от соседей (по времени) по крайней мере на величину <var>p1</var>
по яркости, чтобы рассматриваться как шум. Окружающие пикселы должны
отличаться (от соседей по времени) по крайней мере на <var>p2</var>, 
чтобы рассматриваться как часть того же пятна, и образуя его окружение.</p>
<p><var>pwidth</var> (default 6)<br>
<var>pheight</var> (default 5)<br>
Каждое пятно не может быть больше по ширине&nbsp; <var>pwidth</var> и высоте <var>pheight</var></p>
<p><var>ranked</var> (true or false, default=true)<br>Включает режим ранжированной разности по 6 точкам вместо 2.</p>
<p><var>sign</var> (default 0)<br>Устанавливает режим для удаления только черных или белых пятен или всех:<br>
sign = 0 - любые пятна и их окружение (как в старой версии)<br>
sign = 1 - только черные (темные) пятна и их темное окружение<br>
sign = -1 - только белые (светлые) пятна и их светлое окружение<br>
sign = 2 - только черные (темные) пятна и их любое окружение<br>
sign = -2 - только белые (светлые) пятна и их любое окружение</p>
<p><var>maxpts</var> (from 0 to 10000000, default=0 - без ограничений)<br>
Устанавливает верхний предел числа точек в каждом пятне.</p>
<p><var>minpts</var> (from 0 to 10000000, default=0 - без ограничений)<br>
Устанавливает нижний предел числа точек в каждом пятне.</p>
<p><var>p1percent</var> (from 0 to 100, default=10)<br>
Устанавливает нижний предел относительной доли контрастных (по критерию <var>P1</var>) точек в каждом пятне.</p>
<p><var>dilate</var> (from 0 to 255, default=1)<br>
Устанавливает величину морфологического расширения (роста) пятен (в пикселах).<br>
<br>
<var>fitluma</var> (true or false, default=true)<br>
Разрешает некоторую коррекцию яркости в месте удаленного пятна&nbsp;</p>
<p><var>blur</var> (from 0 to 4, default 1)<br>
Величина (протяженность) пространственного смазывания у границ удаленных пятен<br>
<br>
<var>tsmooth</var> (from 0 to 127, default 0)<br>
Управляет временным сглаживанием (динамическим шумопонижением) в статических областях (вне пятен и движения).<br>Устанавливает примерный порог вариации яркости в трех кадрах,<br>чем больше вариация превышает этот порог, тем меньше временное сглаживание. <br>0 -нет временного сглаживания.</p>
<p><var>motpn</var> (true or false, default = true)<br>
Определяет метод детектирования движения.<br>
false - определить движение от предыдущего до текущего и от текущего до
следующего кадра. (старый метод использовавшийся во всех версиях до
3.0). <br>
true -определить движение от предыдущего до следующего кадра (новый метод с версии 3.0)</p>
<p><var>seg</var> (from 0 to 2, default=2)<br>Определяет режим удаления сегментов пятен.<br>
0 - удаление только пикселов, которые не перекрываются зонами
движения (старый метод использовавшийся во всех версиях до 3.0,
наиболее сильное удаление);<br>
1 - удаление только таких целых сегментов пятен, которые не имеют перекрытия с зонами движения;<br>
2 - удаление только таких цельных пятен, которые не имеют перекрытия с зонами движения&nbsp; (наиболее безопасное).</p>
<p><var>color</var> (true of false, default = false)<br>
Управляет коррекцией цвета пятен.<br>
true - изменять цвет пикселов на месте удаляемых пятен на среднее значение предыдущего, текущего и следующего кадров,<br>
false - не менять цвет пикселов на месте удаляемых пятен.</p>
<p><var>mscene</var> (from 0 to 100, default=40)<br>
Устанавливает процент движущихся пикселов для детектирования смены сцены и отмены удаления пятен на кадре</p>
<p><var>extmask</var> (по умолчанию нет)<br>
Дополнительный клип с внешней маской. Он будет бинаризован с порогом 127 и логически 
добавлен (операцией "ИЛИ") 
к внутренней маске движения. 
Это может быть использовано для дополнительной защиты хороших объектов (если вы имеете некоторую подходящую маску). 
</p>
<h4>Параметры общие для обоих режимов:</h4>
<p><var>mthres</var> (default 16)<br>
Пиксел должен отличаться от другого кадра по крайней мере на <var>mthres</var>, 
чтобы считаться движущимся. Это число должно быть больше чем <var>p2</var>, 
чтобы предотвратить идентификацию шума как движения.</p>
<p><var>mwidth</var> (default 7)<br>
<var>mheight</var> (default 5)<br>Эти параметры управляют поведением
алгоритма удаления шума и расширения карты движения&nbsp;&nbsp;(путем
морфологического открытия, т.е. эрозии и расширения).</p>
<p><var>merode</var> (default = 33)<br>
Параметр определяет порог процента движущихся пикселов в блоке на стадии эрозии.</p>
<p><var>interlaced</var> (true or false)<br>Трактовать ли видео как
чересстрочное или нет (прогрессивное). По умолчанию - false, т.е.
прогрессивное для DeSpot с версии 1.3. (Более старые версии ошибочно
обрабатывали по умолчанию видео как чересстрочное, если оно было
разделено на поля).</p>
<p>&nbsp;&nbsp; Чтобы вместо фильтрации, показать карту движения и пятна,
 которые будут удалены, используйте отладочные параметры:<br>
<var>show</var> (0, 1, 2, default=0)<br>
0 - не показывать,<br>
1 -&nbsp;только
выделить шум вместо его удаления,<br>
2 - показать карту движения и пятна</p>
<p>&nbsp;&nbsp; Если <var>show</var>=1, вы можете использовать дополнительный параметр для изменения цвета выделения:<br>
<var>mark_v</var> (0 to 255, default= 255)<br>Где <var>mark_v</var> - величина яркости чтобы выделить шум.<br>
Цвет шума  (розовый, зеленый или серый) зависит от четности параметра <var>mark_v</var>.<br>
Показывается также карта движения пониженной контрастностью.</p>
<p>Если <var>show</var>=2, при отладке яркость изменяется следующим образом:<br>
255 (белый): Шум, который будет удален<br>
159: Шум, который не будет удален, так как он может быть движением<br>
95: Карта движения для текущего кадра</p>
<p><var>show_chroma</var> (true or false)<br>Показать цветовую информацию на карте движения.</p>
<p><var>bool "planar"</var> : логический флаг использования специального планарного цветового формата для YUY2 клипов 
как на входе, так и на выходе функции. 
Это использует специальный трюк для хранения кадров с планарной цветовой организацией данных 
(отдельные плоскости Y, U, V в памяти) в нормальном чередующемся формате YUY2 кадров как контейнере. 
Таким способом  мы можем избежать многочисленных внутренних преобразований из чередующегося в планарный формат и увеличить скорость.
Вы можете преобразовать нормальный чередующийся YUY2 исходный клип в планарный формат функцией <code>interleaved2planar</code>
из <a href="http://home.pages.at/kassandro/RemoveGrain/">плагина SSETools пакета RemoveGrain от kassandro</a>,
и преобразовать конечный результат функцией <code>planar2interleaved</code>. 
Этот специальный планарный YUY2 также поддерживается плагином Removegrain от Kassandro, 
плагином MaskTools2 от Manao, MVTools v2 и некоторыми другими.
Данный трюк не будет нужен в Avisynth v2.6 с внутренней поддержкой планарного формата YV16.
Данный параметр игнорируется для клипов в формате YV12.
По умолчанию planar=false (и вы получите ошибку для формата YUY2).  </p>

<h3>НАСТРОЙКА ПАРАМЕТРОВ</h3>
<p>Чтобы фильтр работал правильно, различные параметры ДОЛЖНЫ быть установлены. 
Не существует хороших величин по умолчанию.</p>
<p>Первый параметр, который нужно установить, это <var>interlaced</var>, 
установите его равным true, если ваше видео чересстрочное, и false в противном случае.</p>
<p>Затем должны быть установлены <var>pwidth</var> и <var>pheight</var>.
Установите их слегка большими, чем те пятна, которые вы хотите
исключить. Если видео чересстрочное, тогда pheight представляет
высоту в отдельном поле. Таким образом, она будет в сущности удвоена.</p>
<p>Затем должны быть установлены <var>p1</var>, <var>p2</var>, и <var>mthres</var>. 
Вообще, <var>p1 &gt; mthres &gt; p2</var>. Если
они установлены слишком малыми, то вы можете потерять детали, так как
малая вариация пиксела может быть принята за пятно, и более важно,
настоящие пятна могут не распознаться, так как размер того, что фильтр
посчитает пятном, может быть больше чем <var>pwidth</var> на <var>pheight</var>.
<var>show</var>=1 или 2 могут быть полезны в установлении этих параметров.</p>
<p>Установите параметры&nbsp;<var>mwidth</var>, <var>mheight</var> в
соответствии с величиной движения (перемещения) в кадре. Они определяют
зоны безопасности (влияния) вокруг движущихся объектов, в которых пятна
не удаляются. При слишком малых значениях, часть движущегося объекта
может быть принята за пятно, при больших значениях многие пятна не
будут удалены.&nbsp;Чтобы снизить влияние малых областей движения,
можно увеличить параметр <var>merode</var> (от зависимых значений по
умолчанию). Если используется компенсация движения, эти параметры можно
уменьшить для более полного удаления пятен.&nbsp;</p>

<p>Затем можно установить <var>sign</var> если почти все пятна на вашем видео имеют выраженный
черный или наоборот белый оттенок. Учтите и оттенок окантовки
(обрамления) пятен. Правильная настройка параметра может уменьшить число ложных срабатываний фильтра (артефакты).</p>
<p>Я&nbsp; рекомендую использовать новый параметр <var>ranked</var>=true 
для более устойчивого детектирования пятен на шумном видео.</p>
<p>Используйте параметр <var>maxpts</var> как другой метод в дополнение к размерам <var>pwidth</var> и
<var>pheight</var> для избежания очистки слишком больших (по числу точек) объектов - вероятно не пятен.</p>
<p>Используйте параметр <var>p1percent</var>, чтобы не очищать слишком слабые малоконтрастные пятна, 
с малым относительным числом контрастных точек (по порогу <var>p1</var>).</p>
<p>Для более полного удаления частично поврежденных пикселов на
границах не резких пятен, можно расширить пятна (размер очищаемой
области) путем увеличения параметра
<var>dilate</var>.</p>
<p>Разрешите коррекцию яркости в месте удаленных пятен параметром <var>fitluma</var>.</p>
<p>Эта коррекция является локальной (основанная на сегментах) в режимах <var>seg</var>&gt;0
mode и должна быть использована с правильно подобранным расширением
пятен, чтобы предотвратить неверную коррекцию из-за нерезких границ
пятен.</p>
<p>Для снижения заметности границ удаленных пятен, настройте их пространственное смазывание параметром <var>blur</var>.</p>
<p>Для уменьшение шума в статичных областях, попытайтесь использовать временное сглаживание, 
подбирая параметр <var>tsmooth</var> (рекомендую от 4 до 8).</p>
<p>Если пятна имеют некоторый цвет, попробуйте включить параметр<var> color,</var> 
хотя это может привести и к заметности ложных срабатываний.</p>
<p>Чтобы предотвратить артефакты при смене сцены, уменьшите параметр <var>mscene</var>.</p>
<h3>КАК ОН РАБОТАЕТ</h3>
<h4>Фильтр в режиме Denoise работает следующим образом:</h4>

<p>1a) Находит пикселы, которые отличаются от соседей (в соседних кадрах) по крайней мере на <var>p1</var>.<br>
Если параметр  <var>sign</var>
не равен 0, учитывается и знак разности.<br>
Если параметр <var>ranked</var> активен (новый метод с версии 1.3), то
три соседа в предыдущем кадре (x-1, x, x+1)
и 3 соседа в следующем кадре ранжируются (упорядочиваются по величине)
, и их минимум и максимум используются для вычисления текущей разницы
(от данного пиксела x).<br>
Если параметр <var>ranked</var> неактивен (false) (старый метод), 
только один сосед в предыдущем кадре (в той же позиции x)
и один сосед в следующем кадре используются для вычислений минимума и максимума.<br>
Эти пикселы объединяются в линейные горизонтальные сегменты.<br>
Уложенные вертикально сегменты объединяются в пятна.</p>

<p>1b) Увеличивает окружение исходя из <var>p2&lt;p1</var>.</p>
<p>2a) Определяет размер пятен и отвергает (не будет очищать) те, которые больше чем <var>pwidth x pheight</var>.<br>
Если параметр <var>numpts</var> активен, отвергаются также большие пятна (с большим числом точек).<br>
Если параметр <var>p1percent</var> активен, то отвергаются также не очень сильные (по критерию <var>p1</var>)
 пятна, (которые состоят в основном из окружения) (по критерию <var>p2</var>).</p>
<p>2b) Если режим <var>Dilate</var> активен, пятна расширяются на
заданную величину, чтобы полностью покрыть мал<span lang="ru">о</span>контрастные края и
закрыть малые промежутки между ними, путем применения операции
морфологического расширения к карте шума (пятен).</p>
<p>3a) Находит движущиеся области образа путем простого сравнения
каждого пиксела с другим кадром и рассматривая все, для которых разница
больше чем <var>mthres</var>.<br>
    Если <var>motpn</var>=false, рассматривается движение от предыдущего к текущему кадру,<br>
Если <var>motpn</var>=true, рассматривается движение от предыдущего к последующему кадру.</p>
<p>3b) Помечает пикселы, определенные как движение без шума с весом 3 на карте движения.<br>
Если <var>motpn</var>=false, Помечает пикселы, определенные как движение и шум с весом 1 на карте движения.</p>
<p>4) Удаляет шум и малые области из карты движения путем эрозии и затем расширения (итого морфологического открытия).<br>
На стадии эрозии, карта движения эродирует на <var>mwidth</var>/2 и <var>mheight</var>/2, 
и зоны с малым суммарным весом (менее чем 3*<var>merode</var>/100)
уменьшаются или полностью удаляются из карты движения. Такие зоны
отвечают малому относительному числу движущихся соседних пикселов в
этом диапазоне (или большинству точек с шумом).<br>
На стадии расширения, оставшиеся зоны движения расширяются на заданный диапазон.
Это вероятно наиболее важные шаги (особенно если <var>motpn</var>=false).</p>
<p>4a) Если процент движущихся пятен больше чем параметр <var>mscene</var> , 
плагин регистрирует смену сцены, и вся карта движения устанавливается как движущаяся. </p>
<p>4b) Добавляет (опционально) дополнительную внешнюю маску к карте движения.</p> 
<p>5) Удаляет только пятна, в которых нет движения (в текущем или следующем кадре если <var>motpn</var>=false).<br>
В режиме удаления пикселов (<var>seg</var> = 0), проверяет и удаляет только пикселы, 
которые не перекрываются зонами движения, остальные отвергает.<br>
В режиме удаления сегментов (<var>seg</var> = 1), удаление только таких сегментов пятен, 
которые не имеют перекрытия с зонами движения.<br>
В режиме удаления пятен (<var>seg</var> = 2), удаление только таких пятен, которые не имеют перекрытия с зонами
движения  (наиболее безопасное, минимум артефактов ложного удаления).</p>
<p>6) Опционально делает коррекцию яркости и пространственное (по строкам) сглаживание границ пятен.</p>
<p>7) Опционально делает временное (динамическое) сглаживание статичных областей.</p>
<p>8) Опционально корректирует цвет на месте пятен.</p>
<h4>Фильтр в режиме Median работает следующим образом:</h4>

<p>1) Находит движущиеся области образа просто сравнивая каждый пиксел
с предыдущим кадром и рассматривая все, для которых разница больше чем <var>mthres</var>.</p>
<p>2) Удаляет малые области из карты движения путем эрозии и затем
расширения (итого морфологического открытия). Это вероятно
наиболее важный шаг.</p>
<p>3) Применяет простой временной медианный фильтр к не-движущимся частям образа.</p>
<h3>ЗАМЕЧАНИЯ ПО ОПТИМИЗАЦИИ</h3>
<p>DeSpot с версии 3.2 вручную оптимизирован для Integer SSE (Pentium3, Athlon теперь необходимы).<br>
Увеличение скорости до 30%.</p>
<h3>КОМПИЛЯЦИЯ&nbsp;</h3>
<p>Версии Fizick выше 1.1 компилированы с помощью свободного MS VC++ Toolkit 2003 вместе с MS Platform SDK.</p>
<p>Замечание: скопируйте забытые nmake.exe и cvtres.exe из Bin\win64 каталога в Bin.</p>
<p>Также могут быть использованы MS VC6, VC7.</p>
<p>Используйте Nmake.exe и файл "makefile" командой:<br>
NMAKE</p>

<p>Старые версии C-плагина до 1.3 могли компилироваться с помощью GCC и GNU Make. Версии начиная с 2.0 - не могут.</p>
<p>Сейчас я использую despot.cbp проект для CodeBlock IDE.</p>
<h3>СОВМЕСТНОЕ ИСПОЛЬЗОВАНИЕ</h3>
<p>Очень хорошие результаты дает использование данного фильтра
совместно с оценкой и компенсацией движения в кадрах: глобального
движения плагином <a href="depan.htm">DePan</a>, или локального движения плагином
<a href="mvtools.htm">MVTools</a>.</p>
<p>В этом случае фильтр использует скомпенсированные кадры, получаемые
из предыдущего и последующего путем подгонки положения точек к
текущему. Следовательно относительное движение уменьшается, ложное
детектирование пятен уменьшается, и степень подавления шумов
увеличивается.</p>
<p>Пример скрипта с DePan 0.9 (вы можете подстроить дополнительные параметры DePanEstimate):</p>
<pre>AviSource("h:\kino.avi")
LoadPlugin("depan.dll")
LoadPlugin("despot.dll")
i = ConvertToYV12()
d = DePanEstimate(i, trust=3)
DePanInterleave(i, data=d)
DeSpot(p1=30, p2=15, pwidth=800, pheight=600, mthres=20, motpn=true, dilate=1, seg=1)
SelectEvery(3, 1)</pre>
<p>Пример простого скрипта c MVTools версии от 0.95 до 1.X (вы можете подстроить дополнительные параметры MVAnalyse, MVCompensate):</p>
<pre>AviSource("h:\kino.avi")
LoadPlugin("mvtools.dll")
LoadPlugin("despot.dll")
i = ConvertToYV12()
vf = MVAnalyse(i, isb=false)
f = MVCompensate(i, vf)
vb = MVAnalyse(i, isb=true)
b = MVCompensate(i, vb)
Interleave(f, i, b)
DeSpot(p1=30, p2=12, mthres=20, dilate=2, fitluma=true, blur=2, seg=2)
SelectEvery(3,1)</pre>
<p>Пример скрита с внешней маской из плагина MVTools версии 2.3 и выше
(вы можете настроить дополнительные параметры MAnalyse):</p>
<pre>LoadPlugin(&quot;mvtools2.dll&quot;)
LoadPlugin(&quot;mt_masktools-25.dll&quot;)
LoadPlugin(&quot;degrainmedian.dll&quot;)
LoadPlugin(&quot;despot.dll&quot;)

AviSource(&quot;h:\kino.avi&quot;)
i = ConvertToYV12()
prefilt=i.DeGrainMedian() # предварительно фильтрованный клип для лучшего анализа движения

# анализируеи и компенсируем движение вперед и назад (к текущему кадру)
ml = 100     # масштаб маски
thscd1 = 400 # порог смены сцены

super=i.MSuper() # super clip
superprefilt=prefilt.MSuper() # super фильтрованный клип

vf = superprefilt.MAnalyse(isb=false) # вектора вперед 
cf = i.MFlow(super, vf, thscd1 = thscd1) # предыдущий кадр, компенсированный вперед
sadf = i.MMask(vf, ml=ml,kind=1,gamma=1, thscd1 = thscd1) # маска SAD вперед
msadf=sadf.MT_Binarize(20,upper=true) # двоичная инвертированная маска SAD вперед

vb = superprefilt.MAnalyse(isb=true)  # вектора назад 
cb = i.MFlow(super, vb, thscd1 = thscd1) # следующий кадр, компенсированный назад 
sadb = i.MMask(vb, ml=ml, gamma=1, kind=1, thscd1 = thscd1) # маска SAD назад
msadb = sadb.MT_Binarize(20,upper=true) # двоичная инвертированная маска SAD назад

msad = MT_Logic(msadf,msadb,"or") # комбинированная инвертированная маска SAD
msad = msad.MT_Expand() # расширенная маска
msadi = Interleave(msad, msad, msad) # тройное повторение маски
# Эта маска высока (255), где по крайней мере одна из оценок движения хороша, 
# так что эти области будут защищены

# чередуем компенсированный вперед предыдущий, текущий и компенсированный назад следующий кадры
Interleave(cf,i,cb) 

DeSpot(p1=30,p2=12,pwidth=800,pheight=600,mthres=20,merode=33,\
   sign=0,show=1,seg=0,color=true,motpn=true, extmask=msadi)

SelectEvery(3,1) # получаем отфильтрованный источник
</pre>
<h3>Дополнительная информация</h3>
<p>Обсуждение фильтров ConditionalTemporalMedian и Despot на англоязычном форуме:
<cite><a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=59388">http://forum.doom9.org/showthread.php?s=&amp;threadid=59388</a></cite></p>
<h3>ЛИЦЕНЗИЯ</h3>
<p>Данная программа представляет собой свободно распространяемый<br>
программный продукт; вы можете распространять ее далее и\или изменять<br>
на условиях Стандартной публичной лицензии GNU, опубликованной<br>
"Free Software Foundation" -- либо ее версии номер 2, либо (по вашему<br>
выбору) любой более поздней ее версии.</p>
<p>Распространяя данный программный продукт, мы надеемся что он окажется<br>
полезным, но НЕ ДАЕМ НИКАКИХ ГАРАНТИЙ, даже подразумеваемой гарантии<br>
ПРИГОДНОСТИ К КУПЛЕ-ПРОДАЖЕ или ИСПОЛЬЗОВАНИЮ В КОНКРЕТНЫХ ЦЕЛЯХ<br>
(см. "Стандартную публичную лицензию GNU").</p>
<p>(Суть: Вы можете модифицировать и программу и ее исходный код,<br>
но все модификации должны распространяться на таких же условиях, с исходными кодами, свободно).</p>
Документация распространяется на условиях лицензии <a href="http://creativecommons.org/licenses/by-sa/3.0/">CreativeCommons BY-SA 3.0 license.</a>
<p>Прошу рассмотреть возможность финансовой поддержки, чтобы быть зарегистрированным пользователем.</p>
<h3>СПИСОК ИЗМЕНЕНИЙ ВЕРСИЙ</h3>
<ul>
  <li>Версия 3.6.1.0 (11 июня 2010):
    <ul>
      <li>Исправлена ошибка документации в примере с MT_Binarize (спасибо yauz за доклад).</li>
    </ul>
  </li>
  <li>Версия 3.6.1 (25 сентября 2009):
    <ul>
      <li>Исправлена ошибка памяти для color, show, interlaced YV12 (спасибо Иван2009 за доклад).</li>
    </ul>
  </li>
  <li>Версия 3.6.0 (23 Октября 2008):
    <ul>
      <li>Добавил опцию planar для планарного YUY2 формата.</li>
      <li>Исправил утечку памяти в конструкторе (для режимов show).</li>
      <li>Некоторые изменения для предупреждения аварий.</li>
      <li>Наконец исправил странную ошибку доступа с extmask (внешняя маска была отменена для motpn=true, seg=0 в v3.5.1)</li>
    </ul>
  </li>
  <li>Версия 3.5.1 (20 декабря 2007):
    <ul>
      <li>Перекомплирован для исправления странной ошибки доступа. Спасибо, Шушаника, за доклад.</li>
    </ul>
  </li>
  <li>Версия 3.5.0 (14 июля 2006):
    <ul>
      <li>Исправлен пример в документации (msadb). Спасибо johnmeyer за доклад.</li>
    </ul>
  </li>
  <li>Версия 3.5 (26 ноября 2005):
    <ul>
      <li>Добавил опцию клипа внешней маски и пример.</li>
      <li>Изменил по умолчанию <var>motpn</var>=true (было на самом деле false, противореча документации).</li>
    </ul>
  </li>
  <li>Версия 3.4.0 (June 18, 2005) (Fizick):
    <ul>
      <li>Переформатирована документация.</li>
    </ul>
  </li>
  <li>Версия 3.4 (April 11, 2005):
    <ul>
      <li>Добавлен параметр <var>minpts</var>.</li>
    </ul>
  </li>
  <li>Версия 3.3.3 (March 30, 2005):
    <ul>
      <li>Исправлена ошибка с режимом  <var>median</var>&nbsp;(спасибо slk001 за доклад).</li>
    </ul>
  </li>
  <li>Версия 3.3.2 (March 28, 2005):
    <ul>
      <li>Более корректное значение диапазона кэша клипа (2 вместо 
      <span lang="ru">неопределенного</span>).</li>
    </ul>
  </li>
  <li>Версия 3.3.1 (October 8, 2004):
    <ul>
      <li>Исправлены ошибки режима детектирования смены сцены.</li>
    </ul>
  </li>
  <li>Версия 3.3 (August 4, 2004):
    <ul>
      <li>Добавлен параметр <var>mscene</var> для детектирования смены сцены.</li>
    </ul>
  </li>
  <li>Версия 3.2 (July 4, 2004) from 3.1:
    <ul><li>Изменен метод временного сглаживания на более быстрый но простой, новый <var>tsmooth</var> подобен старому <var>tsmooth</var>*2.</li>
      <li>Восстановлена работа медианного режима как в версиях до 3.0.</li>
      <li>Частичная ISSE оптимизация для увеличения скорости (Pentium3, Athlon теперь необходимы).</li>
      <li>Обновлена документация.<br>
</li>
    </ul>
  </li>
  <li>Версия 3.1 (June 27, 2004):
    <ul>
      <li>Добавлена коррекция цвета на месте удаленных пятен.</li>
    </ul>
  </li>
  <li>Версия 3.0 (June 22, 2004):
    <ul>
      <li>Версия 3.0 является крупным обновлением (вероятно альфа с ошибками):</li>
      <li>Добавлен другой метод детектирования движения "<var>motpn</var>" (от предыдущего к последующему).</li>
      <li>Добавлены режимы удаления целых сегментов и пятен "<var>seg</var>"=1,2.</li>
      <li>Изменена коррекция яркости на локальную& в режимах удаления целых сегментов и пятен.</li>
      <li>Удален параметр "<var>mratio</var>" (возврат к значению 3 как в версиях до 2.1).</li>
      <li>Измены некоторые умолчанию.</li>
      <li>Реорганизация исходного кода.</li>
      <li>Обновлена
документация. (Но я ужасаюсь читая русский вариант в моем обратном
переводе с моего так называемого английского, который я всегда пишу
сначала - но видимо мало кто еще читает ...).</li>
    </ul>
  </li>
  <li>Версия 2.1 (June 14, 2004):
    <ul>
      <li>Добавлен параметр "<var>mratio</var>" (он был внутренним =3 во всех предыдущих версиях).</li>
      <li>Изменено значение по умолчанию "<var>merode</var>" на зависящее от "<var>mratio</var>".</li>
      <li>Обновлена документация.</li>
      <li>Наконец я начал понимать как фильтр работает на стадии удаления шума из карты движения :-)</li>
    </ul>
  </li>
  <li>Версия 2.0 (June 10, 2004):
    <ul>
      <li>Версия 2.0 является крупным обновлением (вероятно альфа с ошибками):</li>
      <li>Код основного интерфейса переписан, и теперь фильтр является родным Avisynth плагином (не C-plugin).</li>
      <li>Добавлен параметр "<var>median</var>" вместо функции DeSpotMedian</li>
      <li>Добавлен параметр"<var>show</var>" вместо функций DeSpotMark, DeSpotMap, DeSpotMedianMap</li>
      <li>Параметр "<var>mp</var>" (абсолютный) заменен на "<var>merode</var>" (относительный).</li>
      <li>Заменен параметр "<var>p1percent</var>" на целый.</li>
      <li>Обновлена документация.</li>
    </ul>
  </li>
  <li>Версия 1.3 (June 7, 2004):
    <ul>
      <li>Удален параметр "<var>weak</var>" ( "<var>p1percent</var>" более полезен).</li>
      <li>Добавлен параметр "<var>Dilate</var>" для расширения пятен.</li>
      <li>Исправлена
ошибка с обработкой разделенного на поля видео по умолчанию - теперь по
умолчанию любой источник обрабатывается как прогрессивный.</li>
      <li>Изменен внутренний порядок параметров.</li>
      <li>Изменены значения по умолчанию для ряда параметров на более оптимальные.</li>
      <li>Обновлена документация.</li>
    </ul>
  </li>
  <li>Версия 1.2 (June 01, 2004):
    <ul>
      <li>Добавлены параметры&nbsp; <var>Ranked, weak, maxpts, p1percent,</var></li>
      <li>изменен режим&nbsp; <var>Mark</var> на цветной со слабой картой движения.</li>
    </ul>
  </li>
  <li>Версия 1.1 (May 31, 2004):
    <ul>
      <li>Исходный код совместим с MS VC6, VC7.</li>
    </ul>
  </li>
  <li>Версия 1.0 (Dec 30, 2003)
(Fizick) (not public):
    <ul>
      <li>Добавлен параметр "<var>tsmooth</var>" для временного сглаживания в статичных областях.</li>
      <li>Изменено имя фильтра на DeSpot, имя файла на despot.dll,&nbsp;</li>
      <li>и имена функций:<br>
ConditionalDenoise на DeSpot,<br>
ConditionalDenoiseMark на DeSpotMark,<br>
ConditionalDenoiseMap на DeSpotMap,<br>
ConditionalMedian на DeSpotMedian,<br>
ConditionalMedianMap на DeSpotMedianMap.</li>
      <li>Подправлено описание.</li>
    </ul>
  </li>
  <li>Версия 0.934 (Dec 20, 2003)
(Fizick):
    <ul>
      <li>Добавлены параметры "<var>fitluma</var>", "<var>blur</var>" для снижения заметности мест удаленных пятен.</li>
      <li>Удален параметр "<var>per</var>", ранее использовавшийся для этого.</li>
      <li>Изменено значение по умолчанию параметра <var>mp</var></li>
    </ul>
  </li>
  <li>Версия 0.93c (Nov 30, 2003)
    <ul>
      <li>Изменено имя файла на более короткое ctmedian.dll</li>
      <li>Добавлен ресурс с информаций о версии файла фильтра.</li>
    </ul>
  </li>
  <li>Версия 0.93b (Nov 13, 2003) (Fizick, non public):
    <ul>
      <li>Добавлен параметр "<var>per</var>" степени усреднения на границах пятен.</li>
    </ul>
  </li>
  <li>Версия 0.93a (Nov 7, 2003) (Fizick, non public):
    <ul>
      <li>Добавлен параметр "<var>sign</var>" для удаления только черных или белых пятен.</li>
      <li>Исключена iSSE - оптимизированная версия, оставлена только общая.</li>
    </ul>
  </li>
  <li>Changes 0.93 from 0.92 (Sep 27, 2003)
(Kevin Atkinson)
    <ul>
      <li>Исправлена другая противная ошибка.</li>
      <li>Включена неоптимизированная версия.</li>
      <li>Немного расширено руководство</li>
    </ul>
  </li>
  <li>Changes 0.92 from 0.91 (Sep 10, 2003)
(Kevin Atkinson)
    <ul>
      <li>Исправлена противная ошибка.</li>
    </ul>
  </li>
</ul>
<h3><a href="despot3610.zip">Download DeSpot version 3.6.1.0</a></h3>
<p><a href="../">Вернуться на главную страницу</a></p>

</body>
</html>